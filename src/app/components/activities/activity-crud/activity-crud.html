<div class="container mt-4">
  <div class="d-block d-md-flex align-items-center justify-content-between mb-3">
    <h2 class="mb-3 mb-md-0">Gestión de Actividades</h2>

    <!-- BOTÓN BUSCAR -->
    <div class="d-flex align-items-center gap-3 justify-content-start">
      <app-search-form [filters]="activityFilters" (onSearch)="search($event)"> </app-search-form>

      <!-- BOTÓN CREAR -->
      <button
        type="button"
        class="btn btn-primary d-flex align-items-center gap-2 text-nowrap"
        (click)="openNew()"
      >
        <i class="bi bi-plus-circle"></i>
        Crear
      </button>
    </div>
  </div>

  <!-- TABLA -->
  <app-data-table
    [colArray]="colArray"
    [gridData]="filteredActivities"
    [showView]="true"
    (onView)="view($event)"
    (onEdit)="openEdit($event)"
    (onDelete)="delete($event)"
  >
  </app-data-table>

  <!-- MODAL CREAR/EDITAR -->
  <div class="modal fade" id="activityModal" tabindex="-1" #activityModalRef>
    <div class="modal-dialog">
      <div class="modal-content">
        <!-- HEADER -->
        <div class="modal-header">
          <h5 class="modal-title">
            {{ editingId ? 'Editar Actividad' : 'Nueva Actividad' }}
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <!-- FORM -->
        <form [formGroup]="formActivity">
          <div class="modal-body">
            <!-- TÍTULO -->
            <div class="mb-3">
              <label class="form-label">Título</label>
              <input type="text" class="form-control" formControlName="title" />
              <span class="error">
                @if (formActivity.get('title')?.invalid && formActivity.get('title')?.touched) {
                  @if (formActivity.get('title')?.errors?.['required']) {
                    El título es requerido
                  }
                  @if (formActivity.get('title')?.errors?.['minlength']) {
                    Mínimo 3 caracteres
                  }
                  @if (formActivity.get('title')?.errors?.['maxlength']) {
                    Máximo 80 caracteres
                  }
                }
              </span>
            </div>

            <!-- CATEGORÍA -->
            <div class="mb-3">
              <label class="form-label">Categoría</label>
              <select class="form-select" formControlName="categoryId">
                <option value="">Seleccione una categoría</option>
                @for (c of categories; track $index) {
                  <option [value]="c.id">{{ c.name }}</option>
                }
              </select>
              <span class="error">
                @if (
                  formActivity.get('categoryId')?.invalid && formActivity.get('categoryId')?.touched
                ) {
                  Seleccione una categoría
                }
              </span>
            </div>

            <!-- ORGANIZADOR -->
            <div class="mb-3">
              <label class="form-label">Organizador</label>
              <select class="form-select" formControlName="organizerId">
                <option value="">Seleccione un organizador</option>
                @for (o of organizers; track $index) {
                  <option [value]="o.id">{{ o.name }}</option>
                }
              </select>
              <span class="error">
                @if (
                  formActivity.get('organizerId')?.invalid &&
                  formActivity.get('organizerId')?.touched
                ) {
                  Seleccione un organizador
                }
              </span>
            </div>

            <!-- FECHA DE LA ACTIVIDAD -->
            <div class="mb-3">
              <label class="form-label">Fecha de la actividad</label>
              <input type="date" class="form-control" formControlName="date" [min]="minDate" />
              <span class="error">
                @if (formActivity.get('date')?.invalid && formActivity.get('date')?.touched) {
                  Seleccione una fecha
                }
              </span>
            </div>

            <!-- HORARIO -->
            <div class="mb-3">
              <label class="form-label">Horario</label>
              <div class="d-flex gap-2">
                <div class="flex-fill">
                  <input
                    type="time"
                    class="form-control"
                    formControlName="startTime"
                    placeholder="Hora inicio"
                  />
                </div>
                <div class="flex-fill">
                  <input
                    type="time"
                    class="form-control"
                    formControlName="endTime"
                    placeholder="Hora fin"
                  />
                </div>
              </div>
              <span class="error">
                @if (formActivity.errors?.['horaInvalida'] && formActivity.touched) {
                  La hora de fin debe ser posterior a la hora de inicio
                }
                @if (
                  formActivity.get('startTime')?.invalid && formActivity.get('startTime')?.touched
                ) {
                  Hora de inicio requerida
                }
                @if (formActivity.get('endTime')?.invalid && formActivity.get('endTime')?.touched) {
                  Hora de fin requerida
                }
              </span>
            </div>

            <!-- FECHA LÍMITE DE INSCRIPCIÓN -->
            <div class="mb-3">
              <label class="form-label">Fecha límite de inscripción</label>
              <input
                type="date"
                class="form-control"
                formControlName="registrationDeadline"
                [min]="minDate"
                [max]="maxDeadlineDate"
              />
              <span class="error">
                @if (
                  formActivity.get('registrationDeadline')?.invalid &&
                  formActivity.get('registrationDeadline')?.touched
                ) {
                  Fecha límite requerida
                }
                @if (formActivity.errors?.['deadlineInvalida'] && formActivity.touched) {
                  La fecha límite de inscripción no puede ser posterior a la fecha del evento
                }
              </span>
            </div>

            <!-- LUGAR -->
            <div class="mb-3">
              <label class="form-label">Lugar</label>
              <input type="text" class="form-control" formControlName="location" />
              <span class="error">
                @if (
                  formActivity.get('location')?.invalid && formActivity.get('location')?.touched
                ) {
                  Lugar requerido (mínimo 3 caracteres)
                }
              </span>
            </div>

            <!-- CAPACIDAD -->
            <div class="mb-3">
              <label class="form-label">Capacidad</label>
              <input
                type="number"
                class="form-control"
                formControlName="capacity"
                min="10"
                max="500"
              />
              <span class="error">
                @if (
                  formActivity.get('capacity')?.invalid && formActivity.get('capacity')?.touched
                ) {
                  Capacidad requerida (mínimo 10, máximo 500)
                }
              </span>
            </div>

            <!-- DESCRIPCIÓN -->
            <div class="mb-3">
              <label class="form-label">Descripción</label>
              <textarea class="form-control" rows="3" formControlName="description"></textarea>
              <span class="error">
                @if (
                  formActivity.get('description')?.invalid &&
                  formActivity.get('description')?.touched
                ) {
                  Descripción requerida (mínimo 10 caracteres)
                }
              </span>
            </div>

            <!-- FOTO (URL) -->
            <div class="mb-3">
              <label class="form-label">Foto (URL)</label>
              <input
                type="text"
                class="form-control"
                formControlName="photoUrl"
                (input)="updatePhotoPreview()"
                placeholder="https://ejemplo.com/imagen.jpg"
              />
              <!-- VISTA PREVIA -->
              <div class="mt-2">
                @if (photoPreview) {
                  <img
                    [src]="photoPreview"
                    (error)="photoPreview = null"
                    style="max-width: 140px; border-radius: 8px; border: 1px solid #ccc"
                  />
                } @else {
                  <div
                    class="card-img-top bg-secondary d-flex align-items-center justify-content-center"
                    style="
                      width: 140px;
                      height: 140px;
                      color: white;
                      border-radius: 8px;
                      border: 1px solid #ccc;
                    "
                  >
                    Sin imagen
                  </div>
                }
              </div>
            </div>

            <!-- ACTIVO -->
            @if (editingId) {
              <div class="mb-3">
                <div class="form-check">
                  <input
                    class="form-check-input"
                    type="checkbox"
                    formControlName="active"
                    id="checkActive"
                  />
                  <label class="form-check-label" for="checkActive">Activo</label>
                </div>
              </div>
            }
          </div>

          <!-- BOTONES -->
          <div class="modal-footer">
            <button class="btn btn-secondary" type="button" (click)="modalRef.hide()">
              Cancelar
            </button>
            <button class="btn btn-primary" type="button" (click)="save()">Guardar</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
